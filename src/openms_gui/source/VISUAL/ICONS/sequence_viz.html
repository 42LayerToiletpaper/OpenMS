<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sequence Visualizer</title>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/babel-polyfill" defer></script>
    <!-- Web component polyfill (only loads what it needs) -->
    <script src="https://cdn.jsdelivr.net/npm/@webcomponents/custom-elements@latest"
            defer></script>
    <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
    <script src="https://cdn.jsdelivr.net/npm/@webcomponents/custom-elements@latest/src/native-shim.js"
            defer></script>

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- d3 -->
    <script src="https://cdn.jsdelivr.net/npm/d3@5.9.2" defer></script>

    <!-- protvista components -->
    <script src="https://cdn.jsdelivr.net/npm/protvista-manager@latest" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/protvista-utils@latest" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/protvista-zoomable@latest" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/protvista-track@latest" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/protvista-navigation@latest" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/protvista-tooltip@latest" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/protvista-sequence@latest" defer></script>
    <script defer>
        document.addEventListener("DOMContentLoaded", function () {
            new QWebChannel(qt.webChannelTransport,
            async function(channel){

            let SequenceVisualizer = channel.objects.SequenceVisualizer;

            function hashCode(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                return hash;
            }

            function pickColor(str) {
                return `hsl(${hashCode(str) % 360}, 100%, 80%)`;
            }

            let acc_num = SequenceVisualizer.json_data_obj.accession_num;
            let protein_seq = SequenceVisualizer.json_data_obj.protein_sequence_data;
            let peptides_data_arr = SequenceVisualizer.json_data_obj.peptides_data;
            let protlen = SequenceVisualizer.json_data_obj.protein_sequence_data.length;

            let peptide_obj = [];
            let mod_peptide_obj = [];
            
            if(!protein_seq.length){ 
                async function fetchSeqDataJSON() {
                  const response = await fetch('https://www.ebi.ac.uk/proteins/api/proteins/' + acc_num, {
                        method:'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                  })
                  if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  const data = await response.json();
                  protein_seq = data.sequence.sequence;
                  protlen = data.sequence.length;
                }
                await fetchSeqDataJSON()
            }
       

            for (const pep of peptides_data_arr) {
                let pep_obj = {};

                pep_obj["start"] = pep.start + 1;
                pep_obj["end"] = pep.end + 1;
                pep_obj["accession"] = pep.seq;
                pep_obj["color"] = pickColor(pep.seq);

                peptide_obj.push(pep_obj);
            }

            for (const pepList of peptides_data_arr) {
                for (let mod in pepList.mod_data) {
                    for(const index of pepList.mod_data[mod]){
                        let mod_obj = {};

                        mod_obj["start"] = index + 1;
                        mod_obj["end"] = index + 1;
                        mod_obj["accession"] = pepList.seq;
                        mod_obj["color"] = pickColor(mod);
                        mod_obj["shape"] = "circle";
                        mod_obj["tooltipContent"] = mod;

                        mod_peptide_obj.push(mod_obj);
                    }
                }
            }

            let protNav = `
            <protvista-navigation
                length="${protlen}"
                displaystart="1"
                displayend="${protlen}"
            />
            `
            let protSeq = `
            <protvista-sequence id="seq"
                sequence="${protein_seq}"
                length="${protlen}"
                displaystart="1"
                displayend="${protlen}"
                numberofticks="0"
                use-ctrl-to-zoom="true"
                highlight-event="onmouseover"
            />
            `
            let protTrack = `
            <protvista-track id="track"
                length="${protlen}"
                displaystart="1"
                displayend="${protlen}"
                use-ctrl-to-zoom="true"
                tooltip-event="mouseover"
            />
            `
            let modProtTrack = `
            <protvista-track id="mod_track"
                length="${protlen}"
                displaystart="1"
                displayend="${protlen}"
                use-ctrl-to-zoom="true"
                tooltip-event="mouseover"
            />
            `
            let tooltipHTML = `
            <protvista-tooltip 
                id="toolTip"
            ></protvista-tooltip>`
        
       
            document.querySelector("#toppview_prot_visualizer").data = protein_seq;

            $($.parseHTML(protNav)).appendTo($("#toppview_prot_visualizer"));
            $($.parseHTML(protSeq)).appendTo($("#toppview_prot_visualizer"));
            $($.parseHTML(protTrack)).appendTo($("#toppview_prot_visualizer"));
            $($.parseHTML(modProtTrack)).appendTo($("#toppview_prot_visualizer"));
            $($.parseHTML(tooltipHTML)).appendTo($("#toppview_prot_visualizer"));

            document.querySelector("#track").data = peptide_obj;
            document.querySelector("#mod_track").data = mod_peptide_obj;

            const trackElement = document.querySelector('#track');
            const modTrackElement = document.querySelector('#mod_track');
	        const toolTipElement = document.querySelector('#toolTip');

	        modTrackElement.addEventListener('change', (event) => {
		        if(event.detail.eventtype == "mouseover"){
                    let pep_mod_data = event.detail.feature;
			        let x = event.detail.coords[0];
	  		        let y = event.detail.coords[1];
	  		        toolTipElement.visible = true;
	  		        toolTipElement.x = x;
	  		        toolTipElement.y = y;	
                    toolTipElement.title = pep_mod_data.tooltipContent;
                    toolTipElement.innerHTML = pep_mod_data.accession;
		        }
		        if(event.detail.eventtype == "mouseout"){
			        toolTipElement.visible = false;
		        }
	        });

            trackElement.addEventListener('change', (event) => {
		            if(event.detail.eventtype == "mouseover"){
                        let pep_data = event.detail.feature
			            let x = event.detail.coords[0];
	  		            let y = event.detail.coords[1];
	  		            toolTipElement.visible = true;
	  		            toolTipElement.x = x;
	  		            toolTipElement.y = y;	
                        toolTipElement.title = "Peptide " + pep_data.start + "-" + pep_data.end;
                        toolTipElement.innerHTML = pep_data.accession;
		            }
		            if(event.detail.eventtype == "mouseout"){
			            toolTipElement.visible = false;
		            }
	            });
            });
        });
    </script>
    <style>
		
		.helpBtn {
		  position: absolute;
		  bottom: 10px;
		  left: 10px;
		  display: inline-block;
		  border: 1px solid black;
		  border-radius: 4px;
		  padding: 5px 10px;
		}

		.helpBtn .helpText {
		  visibility: hidden;
		  width: max-content;
		  background-color: white;
		  color: #000;
		  border: 1px solid black;
		  border-radius: 6px;
		  padding: 10px 20px;
		  position: absolute;
		  z-index: 1;
		  bottom: 150%;
		  left: 50%;
		  text-align: left;
		}

		.helpBtn .helpText::after {
		  content: "";
		  position: absolute;
		  top: 100%;
		  left: 2%;
		  border-width: 10px;
		  border-style: solid;
		  border-color: black transparent transparent transparent;
		}
        .helpBtn:hover {
            cursor: pointer;
        }
		.helpBtn:hover .helpText {
		  visibility: visible;
		}
	</style>
</head>
<body>
    <protvista-manager attributes="length displaystart displayend highlight onclick"
                       id="toppview_prot_visualizer">
    </protvista-manager>
    <div class="helpBtn">
        Help
        <div class="helpText">
            <span>1) Keep your mouse over a track and use <kbd>ctrl + scroll</kbd> to zoom in/out</span><br>
            <span>2) Hover over the modification track to view modification data</span><br>
            <span>3) Hover over the peptide track to view peptide data</span>
        </div>
    </div>
</body>
</html>
